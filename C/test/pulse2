#include <stdio.h>
#include <unistd.h>
#include "rp.h"
#include "rp_sweep.h"

int main() {
    // Init the base generator API
    if (rp_Init() != RP_OK) {
        fprintf(stderr, "rp_Init failed\n");
        return -1;
    }

    // Init Sweep engine
    if (rp_SWInit() != RP_OK) {
        fprintf(stderr, "rp_SWInit failed\n");
        return -1;
    }

    // Basic settings
    float start_freq = 100000;  // 100 kHz
    float stop_freq  = 300000;  // 300 kHz
    int   sweep_time = 100000;  // 100,000 us = 100 ms

    // Reset sweep system
    rp_SWResetAll();

    // Set sweep parameters
    rp_SWSetStartFreq(RP_CH_1, start_freq);
    rp_SWSetStopFreq (RP_CH_1, stop_freq);
    rp_SWSetTime     (RP_CH_1, sweep_time);
    rp_SWSetMode     (RP_CH_1, RP_GEN_SWEEP_MODE_LINEAR);
    rp_SWSetDir      (RP_CH_1, RP_GEN_SWEEP_DIR_UP);  // just sweep upward

    // Make sure generator is configured
    rp_GenReset();
    rp_GenWaveform(RP_CH_1, RP_WAVEFORM_SINE);
    rp_GenAmp(RP_CH_1, .5);

    // Enable sweep for this channel
    rp_SWGenSweep(RP_CH_1, true);

    // Start output
    rp_GenOutEnable(RP_CH_1);

    // Start sweep engine
    rp_SWRun();

    // Wait long enough
    usleep(sweep_time * 2);

    rp_SWStop();
    rp_GenOutDisable(RP_CH_1);

    rp_SWRelease();
    rp_Release();
    return 0;
}
