#include <stdio.h>

#include <stdlib.h>

#include <unistd.h>

#include "rp.h"



#define CHUNK_SIZE 4096



int main() {

    if (rp_Init() != RP_OK) {

        fprintf(stderr, "Failed to initialize Red Pitaya API!\n");

        return -1;

    }



    // Allocate buffers

    float *adc_buf = malloc(CHUNK_SIZE * sizeof(float));

    float *dac_buf = malloc(CHUNK_SIZE * sizeof(float));

    if (!adc_buf || !dac_buf) return -1;



    // ===== Configure ADC =====

    rp_AcqReset();

    rp_AcqSetDecimation(RP_DEC_1);

    rp_AcqSetTriggerSrc(RP_TRIG_SRC_DISABLED); // free-running

    rp_AcqStart();



    // ===== Configure DAC =====

    rp_GenReset();

    rp_GenOutEnable(RP_CH_1);

    rp_GenWaveform(RP_CH_1, RP_WAVEFORM_ARBITRARY);

    rp_GenAmp(RP_CH_1, 1.0);

    rp_GenRepeat(RP_CH_1); // continuous looping



    printf("Starting continuous ADC->DAC loop.\n");



    while (1) {

        uint32_t buf_size = CHUNK_SIZE;

        rp_AcqGetNewestDataV(RP_CH_1, &buf_size, adc_buf);



        // Apply low-pass filter

        float alpha = 0.05;

        dac_buf[0] = adc_buf[0];

        for (int i = 1; i < buf_size; i++)

            dac_buf[i] = dac_buf[i-1] + alpha * (adc_buf[i] - dac_buf[i-1]);



        // Optional amplitude scaling

        for (int i = 0; i < buf_size; i++)

            dac_buf[i] *= 0.5;



        // Load chunk into DAC and play

        rp_GenArbWaveform(RP_CH_1, dac_buf, buf_size);

        rp_GenWaveform(RP_CH_1, RP_WAVEFORM_ARBITRARY); // restart waveform

    }



    rp_GenOutDisable(RP_CH_1);

    rp_Release();

    free(adc_buf);

    free(dac_buf);

    return 0;

}
